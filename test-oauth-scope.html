<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç OAuth scope - –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        body { padding: 40px; background: #f5f7fa; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { margin-bottom: 30px; color: #333; }
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .card h2 { margin-bottom: 15px; color: #333; font-size: 18px; }
        .scope-code { background: #f0f0f0; padding: 10px 15px; border-radius: 6px; font-family: monospace; font-size: 14px; margin-bottom: 15px; }
        .btn { display: inline-block; padding: 12px 24px; background: #fc0; color: #000; text-decoration: none; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; }
        .btn:hover { background: #f9a800; }
        .result { margin-top: 15px; padding: 12px; border-radius: 6px; font-size: 14px; }
        .result.success { background: #e8f5e9; color: #2e7d32; }
        .result.error { background: #ffebee; color: #c62828; }
        .result.info { background: #e3f2fd; color: #1976d2; }
        .log { background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 6px; font-family: monospace; font-size: 13px; margin-top: 15px; max-height: 300px; overflow-y: auto; }
        .debug-info { margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç OAuth scope –¥–ª—è –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞</h1>
        
        <div class="debug-info">
            <strong>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</strong>
            <ol style="margin-top: 10px; padding-left: 20px;">
                <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É —Å —Ä–∞–∑–Ω—ã–º scope</li>
                <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –æ–∫–Ω–µ –Ø–Ω–¥–µ–∫—Å–∞</li>
                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∫–∞–∫–æ–π scope —Ä–∞–±–æ—Ç–∞–µ—Ç</li>
                <li>–£—Å–ø–µ—à–Ω—ã–π —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage</li>
            </ol>
        </div>

        <div class="card">
            <h2>–í–∞—Ä–∏–∞–Ω—Ç 1: <code>disk:app_folder</code></h2>
            <div class="scope-code">scope=disk:app_folder</div>
            <button class="btn" onclick="testScope('disk:app_folder')">üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="result1" class="result" style="display:none;"></div>
        </div>

        <div class="card">
            <h2>–í–∞—Ä–∏–∞–Ω—Ç 2: <code>cloud_api:disk_app_folder</code></h2>
            <div class="scope-code">scope=cloud_api:disk_app_folder</div>
            <button class="btn" onclick="testScope('cloud_api:disk_app_folder')">üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="result2" class="result" style="display:none;"></div>
        </div>

        <div class="card">
            <h2>–í–∞—Ä–∏–∞–Ω—Ç 3: <code>disk</code> (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø)</h2>
            <div class="scope-code">scope=disk</div>
            <button class="btn" onclick="testScope('disk')">üîó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="result3" class="result" style="display:none;"></div>
        </div>

        <div class="log" id="log">
            > –û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤...
        </div>

        <div class="card" style="margin-top: 20px;">
            <h2>üì¶ –¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω –≤ localStorage</h2>
            <button class="btn" onclick="checkToken()" style="margin-bottom: 15px;">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button class="btn" onclick="clearToken()" style="background: #dc3545; color: white;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            <pre id="tokenInfo" style="margin-top: 15px; background: #f0f0f0; padding: 15px; border-radius: 6px; overflow-x: auto;"></pre>
        </div>
    </div>

    <script>
        const CLIENT_ID = '2a94b6a0e172478fb391f58901a12446';
        const REDIRECT_URI = 'https://kkav45.github.io/sopb/yandex-auth-callback.html';

        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `\n> [${time}] ${message}`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function testScope(scope) {
            log(`–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ —Å–æ scope: ${scope}`);
            
            const params = new URLSearchParams({
                response_type: 'token',
                client_id: CLIENT_ID,
                redirect_uri: REDIRECT_URI,
                scope: scope,
                force_confirm: 'yes'
            });

            const authUrl = `https://oauth.yandex.ru/authorize?${params}`;
            log(`–û—Ç–∫—Ä—ã–≤–∞–µ–º: ${authUrl.substring(0, 100)}...`);

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
            const popup = window.open(authUrl, '_blank', 'width=600,height=700');
            
            // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç popup
            window.addEventListener('message', function handleMessage(event) {
                if (event.data && event.data.type === 'YANDEX_TOKEN') {
                    log(`‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω –¥–ª—è scope: ${scope}`);
                    popup.close();
                    showResult(scope, true, '–¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!');
                    window.removeEventListener('message', handleMessage);
                }
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º hash —Ç–µ–∫—É—â–µ–≥–æ –æ–∫–Ω–∞ (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –≤ —Ç–æ–º –∂–µ –æ–∫–Ω–µ)
            setTimeout(() => {
                const hash = window.location.hash;
                if (hash && hash.includes('access_token')) {
                    log(`‚úÖ –¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω (hash) –¥–ª—è scope: ${scope}`);
                    showResult(scope, true, '–¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω!');
                } else if (hash && hash.includes('error')) {
                    const params = new URLSearchParams(hash.substring(1));
                    const error = params.get('error');
                    const errorDesc = params.get('error_description');
                    log(`‚ùå –û—à–∏–±–∫–∞: ${error} - ${errorDesc}`);
                    showResult(scope, false, `${error}: ${errorDesc}`);
                }
            }, 3000);
        }

        function showResult(scope, success, message) {
            let resultId;
            if (scope === 'disk:app_folder') resultId = 'result1';
            else if (scope === 'cloud_api:disk_app_folder') resultId = 'result2';
            else resultId = 'result3';

            const el = document.getElementById(resultId);
            el.style.display = 'block';
            el.className = `result ${success ? 'success' : 'error'}`;
            el.textContent = message;
        }

        function checkToken() {
            const tokenStr = localStorage.getItem('yandex-disk-token');
            const pre = document.getElementById('tokenInfo');
            
            if (!tokenStr) {
                pre.textContent = '–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω';
                log('–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ localStorage');
                return;
            }

            try {
                const token = JSON.parse(tokenStr);
                const expiresAt = token.expiresAt ? new Date(token.expiresAt).toLocaleString() : '–ù/–î';
                const isExpired = Date.now() >= token.expiresAt;
                
                pre.textContent = JSON.stringify({
                    'Access Token': token.accessToken ? token.accessToken.substring(0, 30) + '...' : '–ù–µ—Ç',
                    'Refresh Token': token.refreshToken ? '–ï—Å—Ç—å' : '–ù–µ—Ç',
                    '–ò—Å—Ç–µ–∫–∞–µ—Ç': expiresAt,
                    '–ò—Å—Ç—ë–∫': isExpired ? '‚ùå –î–∞' : '‚úÖ –ù–µ—Ç'
                }, null, 2);
                
                log('–¢–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω: ' + (isExpired ? '–∏—Å—Ç—ë–∫' : '–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω'));
            } catch (e) {
                pre.textContent = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ' + e.message;
            }
        }

        function clearToken() {
            localStorage.removeItem('yandex-disk-token');
            document.getElementById('tokenInfo').textContent = '–¢–æ–∫–µ–Ω —É–¥–∞–ª—ë–Ω';
            log('–¢–æ–∫–µ–Ω –æ—á–∏—â–µ–Ω –∏–∑ localStorage');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –ø–æ—Å–ª–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –æ—Ç –Ø–Ω–¥–µ–∫—Å–∞
        window.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash;
            if (hash && hash.includes('access_token')) {
                const params = new URLSearchParams(hash.substring(1));
                const accessToken = params.get('access_token');
                const expiresIn = params.get('expires_in');

                if (accessToken) {
                    localStorage.setItem('yandex-disk-token', JSON.stringify({
                        accessToken: accessToken,
                        refreshToken: null,
                        expiresAt: Date.now() + (parseInt(expiresIn) || 31536000) * 1000
                    }));

                    log('‚úÖ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ localStorage');
                    
                    // –û—á–∏—â–∞–µ–º hash
                    window.history.replaceState({}, '', window.location.pathname);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    alert('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!\n–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ localStorage.');
                }
            } else if (hash && hash.includes('error')) {
                const params = new URLSearchParams(hash.substring(1));
                const error = params.get('error');
                const errorDesc = params.get('error_description');
                
                log(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error} - ${errorDesc}`);
                alert(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏\n\n${error}: ${errorDesc}`);
                
                // –û—á–∏—â–∞–µ–º hash
                window.history.replaceState({}, '', window.location.pathname);
            }

            checkToken();
        });
    </script>
</body>
</html>
